---
title: "P.salmonis"
output: html_notebook
---
```{r}
library(easypackages)
librerias <- c("GEOquery","Biobase","BiocGenerics","magrittr","tidyr","dplyr","stringr","limma","EnhancedVolcano", "purrr","foreach","tidyverse", "xlsx","Hmisc", "tidyverse", "PAA", "data.table")
libraries(librerias)
```

```{r}
#Rutas de guardado y lectura
pth <- file.path(getwd(),'mis_gse_data_1.rds')
path <- file.path(getwd(), 'mis_target.psalmonis.rds')
saving <- file.path(getwd(),'tabla_targets_p_salmonis.rds')
```

```{r}
titulos                 <- data.frame()
list_con_eset_filtrados <- list()
RDS<- readRDS(pth)
b <- RDS %>% names
for(i in 1:length(b)) {
  if  (b[i] == "GSE1012"| b[i]== "GSE1031"){
     RDS[[i]]  -> mi.gse;
    pData(mi.gse) %>% filter(str_detect(source_name_ch1,'(?i)Non-infected|Piscirickettsia') & str_detect(source_name_ch2,'(?i)Non-infected|(?i)Piscirickettsia')) %>% rownames %>% mi.gse[, .] ->               un_eset_filtrado
    }
  else if (b[i] == "GSE43255"){
       RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title, 'High')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado
  } 
  titulos <- bind_rows(titulos,pData(un_eset_filtrado) )

  list_con_eset_filtrados[[b[i]]] <- un_eset_filtrado
}
list_con_eset_filtrados %>% map(pData) %>% enframe%>%  unnest %>% 
                     dplyr::select(matches('^name$|title|geo|source|characteristics|organism')) -> GSMs_filtrados
```

```{r}
list_con_eset_filtrados$GSE1031 -> un_estudio 
un_estudio %>% pData %>% select(matches('geo')| matches('source.*ch')) %>% unite("Cy3",source_name_ch1) %>%unite("Cy5",source_name_ch2) %>%  mutate_at('Cy3', ~str_replace(.,'.*Non-infected.*', 'control')) %>% mutate_at('Cy3', ~str_replace(.,'.*salmonis-infected.*', 'infected')) %>% mutate_at('Cy5', ~str_replace(.,'.*Non-infected.*', 'control')) %>% mutate_at('Cy5', ~str_replace(.,'.*salmonis-infected.*', 'infected')) %>% select(matches('geo')|matches('cy')) -> GSE1031 

list_con_eset_filtrados$GSE1012 -> un_estudio 
un_estudio %>% pData %>% select(matches('geo')| matches('source.*ch')) %>% unite("Cy3",source_name_ch1) %>%unite("Cy5",source_name_ch2) %>%  mutate_at('Cy3', ~str_replace(.,'(?i).*Non-infected.*', 'control')) %>% mutate_at('Cy3', ~str_replace(.,'.*salmonis-infected.*', 'infected')) %>% mutate_at('Cy5', ~str_replace(.,'(?i).*Non-infected.*', 'control')) %>% mutate_at('Cy5', ~str_replace(.,'.*salmonis-infected.*', 'infected')) -> GSE1012

list_con_eset_filtrados$GSE43255 -> un_estudio 
un_estudio %>% pData %>% select(matches('source_name_ch*') | matches('geo')| matches('label')) %>% unite("Cy3", source_name_ch1) %>%unite("Cy5", source_name_ch2) %>% mutate_at("Cy3",~str_replace(.,'.*challenged.*', 'infected')) %>% mutate_at("Cy5",~str_replace(.,'.*control.*', 'control')) %>% select(matches('geo')|matches('cy'))->GSE43255
```



```{r}
## estudios que tienen match con Salmo salar
RDS$GSE1012 %>% pData() #p. salmonis Atlantic Salmon
RDS$GSE1031 %>% pData() #p. salmonis Atlantic Salmon 
RDS$GSE43255%>% pData() %>% select(matches("organism_ch*")) # p. salmonis, PAPER PROFE




### podria ser utilizados para enrobustecer el grupo Control
RDS$GSE19630 %>% pData() %>% select(matches("organism_ch*")) #Anemia virus ISAV
RDS$GSE26984 %>% pData() %>% select(matches("organism_ch*")) # challenged with l. salmonis
RDS$`GSE28843-GPL10679` %>% pData() %>% select(matches("organism_ch*")) # piscine myocarditis virus
RDS$`GSE28843-GPL10705` %>% pData() %>% select(matches("organism_ch*"))#  piscine myocarditis virus
RDS$GSE28357 %>% pData() %>% select(matches("organism_ch*")) # Isav exposure
RDS$GSE36072%>% pData() %>% select(matches("organism_ch*")) #parasitic copepod Lepeophtheirus salmonis
RDS$GSE36332%>% pData() %>% select(matches("organism_ch*"))# Y. ruckeri
RDS$GSE101695%>% pData() %>% select(matches("organism_ch*")) #Salmo trutta L. garvieae-infected
RDS$GSE140756%>% pData() %>% select(matches("organism_ch*")) #Chalimus 

```

```{r}
llist(GSE1012,GSE1031,GSE43255) -> mis.targets

saveRDS(mis.targets, path)
mis.targets <- readRDS(path)
```

```{r}
## En caso de no tener los archivos gsms en el directorio local
get_my_GSM <- function(un_codigo_gsm){ purrr::map(un_codigo_gsm,
                                      function(un_codigo_gsm){ try(
                                        GEOquery::getGEOSuppFiles(un_codigo_gsm, makeDirectory = TRUE, baseDir =getwd(), fetch_files = T ) )%>% 
                                          rownames}) %>% unlist}
purrr::map(mis.targets, purrr::pluck("geo_accession")) -> mi_lista_GSE_GSM
mis.targets %<>% enframe %>% unnest 
purrr::map(mi_lista_GSE_GSM,get_my_GSM) -> all_gsms
all_gsms %>% enframe %>% unnest %>% mutate(geo_accession = str_extract(value, 'GSM\\d+') ) -> all_gsms_final
inner_join(mis.targets,all_gsms_final, by=c("geo_accession") ) -> target_final
### En caso de tener los archivos en el directorio local
saveRDS(target_final, saving)
target_final <- readRDS(saving)
#full_join(mis.targets,hola2, by=c("geo_accession") ) -> target_final2
#identical(target_final$name.x, target_final$name.y) # just a check

```

```{r}
##Comparador para descompresiones ordenadas

str_extract(target_final$value, "[.]([a-z])*[.]") %>% unique() -> Extensiones
all_extensions <- c(".tif.",".gpr.",".ftr.",".txt." ,".xml.", ".tsv." )

```

```{r}
#Declaración de listas vacias
archivos_tif <- list()
archivos_gpr <- list()
archivos_ftr <- list()
archivos_txt <- list()
archivos_xml <- list()
archivos_tsv <- list()
whole_files <- list()
gsms_ftr <- list()
gsms_txt <- list()
gsms_gpr <- list()
gsms_xml <- list()
gsms_tif <- list()
gsms_tsv <- list()
##Todos los listas de gsms también son innecesarias 
for (i in 1:length(target_final$value)){
  
  if (str_extract(target_final$value[i], "[.]([a-z])*[.]") == ".tif." ){
    
    archivos_tif <-append(archivos_tif,target_final$value[i])
     gsms_tif <- append(gsms_tif, str_extract(target_final$value[i], "GSM\\d+") )
     whole_files <- append(whole_files, archivos_tif)
    }
  else if (str_extract(target_final$value[i], "[.]([a-z])*[.]") == ".ftr." ){
    archivos_ftr <-append(archivos_ftr,target_final$value[i])
    gsms_ftr <- append(gsms_ftr, str_extract(target_final$value[i], "GSM\\d+") )
    whole_files <- append(whole_files, archivos_ftr)
  }
  else if (str_extract(target_final$value[i], "[.]([a-z])*[.]") == ".xml." ){
    archivos_xml <-append(archivos_xml,target_final$value[i])
    gsms_xml <- append(gsms_xml, str_extract(target_final$value[i], "GSM\\d+") )
    whole_files <- append(whole_files, archivos_xml)
  }
  else if (str_extract(target_final$value[i], "[.]([a-z])*[.]") == ".txt." ){
    archivos_txt <-append(archivos_txt,target_final$value[i])
    gsms_txt <- append(gsms_txt, str_extract(target_final$value[i], "GSM\\d+") )
    whole_files <- append(whole_files, archivos_txt)
  }
  else if (str_extract(target_final$value[i], "[.]([a-z])*[.]") == ".gpr." ) {
    archivos_gpr <-append(archivos_gpr,target_final$value[i])
    gsms_gpr <- append(gsms_gpr, str_extract(target_final$value[i], "GSM\\d+") )
    whole_files <- append(whole_files, archivos_gpr)
  }
  else if (str_extract(target_final$value[i], "[.]([a-z])*[.]") == ".tsv.") {
    archivos_tsv <-append(archivos_tsv,target_final$value[i])
    gsms_tsv<- append(gsms_tsv, str_extract(target_final$value[i], "GSM\\d+") )
    whole_files <- append(whole_files, archivos_tsv)
  }
  
}
archivos_tif %>%  unlist() -> archivos_tif
archivos_gpr  %>% unlist() -> archivos_gpr
archivos_ftr  %>% unlist()  -> archivos_ftr
archivos_txt  %>% unlist()  -> archivos_txt
archivos_xml  %>% unlist()  -> archivos_xml
archivos_tsv  %>% unlist()  -> archivos_tsv
whole_files %>% unlist() %>% unique() -> whole_files


#esto también es innecesario
gsms_ftr %>%  unlist() %>% unique()-> gsms_ftr
gsms_txt %>%  unlist() %>% unique() -> gsms_txt
gsms_gpr %>%  unlist() %>% unique() -> gsms_gpr
gsms_tif %>%  unlist() %>% unique() -> gsms_tif
gsms_xml %>%  unlist() %>% unique() -> gsms_xml
gsms_tsv%>%  unlist() %>% unique() -> gsms_tsv
```


```{r}
unpack <- function(path){
  gunzip(path, remove = F, overwrite = T)
 }
test <- Vectorize(unpack)
test(target_final$value)
```

```{r}
### for GPR files

extracted_gpr <- gsub('.gz', '',archivos_gpr) %>% unique()
parsing_from_match_to_end <- function(file_path){
    as.data.frame(fread(file = file_path,sep = '\t', skip = 'Block')) -> out
    return(out)
}
baptism <- function(path){
  id <-str_extract(path, 'GSM\\d+')
  return(id)
  
}
z<- extracted_gpr %>% map_chr(~baptism(.))
my.gpr.DFs <-map(extracted_gpr, parsing_from_match_to_end)
names(my.gpr.DFs) <- z
FileName <- list()

for(i in 1:length(names(my.gpr.DFs))){
  
                                            a.data.study          <- my.gpr.DFs[[i]]
                                            #
                                            my.cols.init.names    <- a.data.study %>% names() %>%
                                            str_extract_all("(^F[0-9]{3}.*Mean$)|(^B[0-9]{3}.*Mean$)|(^F[0-9]{3}+.*Median$)|(^B[0-9]{3}.*Median$)") %>% unlist
                                            #
                                            my.cols.init.names %>% str_replace_all('[:whitespace:]|(Rgn.*R.*)|\\.', '')  -> my.cols.names.ok
                                            
                                           colnames(my.gpr.DFs[[i]][, my.cols.init.names]) <- my.cols.names.ok
                                            DF_ok <- my.gpr.DFs[[i]]
                                            
                                            names(my.gpr.DFs)[i] -> mi_gsm_en_la_iteracion
                                            
                                            str_extract(extracted_gpr, paste0(".*", mi_gsm_en_la_iteracion, ".*")) %>% 
                                              na.omit() %>% as.character() -> mi_ruta_al_gpr_en_la_iteracion
                                            
                                            str_replace(mi_ruta_al_gpr_en_la_iteracion,  "\\.gpr", "_Corrected.gpr") -> new.FileName.path
                                   for (j in 1:length(new.FileName.path)){
                                     write_delim(DF_ok, path= new.FileName.path[j], delim = "\t", na = "NA", append = FALSE)
                                    FileName <- append(FileName,new.FileName.path)  
                                   }                 
                                   
                                                  
}
my.gpr.DFs
```


```{r}
FileName<- FileName %>% unique()
FileName %>% str_extract('GSM\\d+') -> sample.names
sample.names_files <- cbind(row.names = sample.names,FileName)
target_final %>% filter(str_detect(value, '[.](gpr)*[.]')) ->target.ok
target.ok$value <- FileName %>% unlist()
```

```{r}
#separar por cada GSE, y loopear
colnames(target.ok)[6] <- c("FileName")
RG          <- read.maimages(target.ok ,source = "generic", columns = list(R="F633Mean" ,G="F543Mean",Rb="B633Median",Gb="B543Median"), annotation = c("ProbeName", "SequenceID"))
RG.bc2      <-backgroundCorrect(RG,method="normexp")
RG.bc2.norm <- normalizeWithinArrays(RG.bc2, method="loess", weights = NULL)
modelMatrix(target.ok, ref = 'control') -> design
my.gpr.DFs[1]

fit.1  <- lmFit(RG.bc2.norm,  design %>% as.matrix() %>% trqwe::set_colnames(design))

fit2.1 <- eBayes(fit.1)
diffexp            <- topTable(fit2.1, coef = colnames(design),confint = T, adjust.method="BH",sort.by = 'p', number=Inf)
diffexp            <- data.frame(ID = diffexp[,1], log2FC = diffexp$logFC, adj.P.Val = diffexp$adj.P.Val,  CI.L = diffexp$CI.L, CI.R = diffexp$CI.R)
```

```{r}
for(i in 1:length(archivos_ftr)){
                                  line      <- 0L
                                  input     <- 'string_inicial'
                                  a.file    <- archivos_ftr[i]
                                  sample.id <- str_extract(a.file, 'GSM\\d+')
                                  #leemos linea por linea hasta encontrar la regex 
                                  while(!str_detect(input, regex('^FEATURES|^block', ignore_case = T))){
                                       line  <- line + 1L
                                       input <- read_lines(a.file, skip = line - 1L, n_max = 1L)
                                       }
                                  
                                as.data.frame(read_delim(a.file, delim = '\t', skip = line-1)) -> my.ftr.DFs[[sample.id]]
                                  
}
```


```{r}
for(i in 1:length(archivos_tsv)){
                                  line      <- 0L
                                  input     <- 'string_inicial'
                                  a.file    <- archivos_tsv[i]
                                  sample.id <- str_extract(a.file, 'GSM\\d+')
                                  #leemos linea por linea hasta encontrar la regex 
                                  while(!str_detect(input, regex('^FEATURES|^block', ignore_case = T))){
                                       line  <- line + 1L
                                       input <- read_lines(a.file, skip = line - 1L, n_max = 1L)
                                       }
                                  
                                as.data.frame(read_delim(a.file, delim = '\t', skip = line-1)) -> my.tsv.DFs[[sample.id]]
                                  
}

```

```{r}
#chequeo que están las cuatro columnas que necesitamos
#Chequear que hayan exponenciales, subínides ni superíndices.
my.gpr.DFs[[1]] %>% colnames() %>% str_extract_all('^rMeanSignal$|^gMeanSignal$|^rBGMedianSignal$|^gBGMedianSignal$') %>% unlist()
```

```{r}
for(i in 1:length(names(my.txt.DFs))){
  
                                            a.data.study          <- my.txt.DFs[[i]]
                                            #
                                            my.cols.init.names    <- a.data.study %>% names() %>%
                                            str_extract_all("(^F[0-9]+.*Mean$)|(^B[0-9]+.*Mean$)|(Rgn.*R.*)|(r|g)MeanSignal$|(r|g)BGMedianSignal$") %>% unlist
                                            #
                                            my.cols.init.names %>% str_replace_all('[:whitespace:]|(Rgn.*R.*)', '')  -> my.cols.names.ok
                                            
                                            colnames(my.txt.DFs[[i]][, my.cols.init.names]) <- my.cols.names.ok
                                            DF_ok <- my.txt.DFs[[i]]
                                            
                                            names(my.txt.DFs)[i] -> mi_gsm_en_la_iteracion
                                            
                                            str_extract(archivos_txt, paste0(".*", mi_gsm_en_la_iteracion, ".*")) %>% 
                                              na.omit() %>% as.character() -> mi_ruta_al_txt_en_la_iteracion
                                            
                                            str_replace(mi_ruta_al_txt_en_la_iteracion,  "\\.txt", "_Corrected.txt") -> new.FileName.path
 
                                            write_delim(DF_ok, path= new.FileName.path, delim = "\t", na = "NA", append = FALSE)
                                            }
```

```{r}
### For GPR files

for(i in 1:length(names(my.gpr.DFs))){
  
                                            a.data.study          <- my.gpr.DFs[[i]]
                                            #
                                            my.cols.init.names    <- a.data.study %>% names() %>%
                                            str_extract_all("(^F[0-9]{3}.*Mean$)|(^B[0-9]{3}.*Mean$)|(^F[0-9]{3}+.*Median$)|(^B[0-9]{3}.*Median$)") %>% unlist
                                            #
                                            my.cols.init.names %>% str_replace_all('[:whitespace:]|(Rgn.*R.*)', '')  -> my.cols.names.ok
                                            
                                            colnames(my.gpr.DFs[[i]][, my.cols.init.names]) <- my.cols.names.ok
                                            DF_ok <- my.gpr.DFs[[i]]
                                            
                                            names(my.gpr.DFs)[i] -> mi_gsm_en_la_iteracion
                                            
                                            str_extract(archivos_gpr, paste0(".*", mi_gsm_en_la_iteracion, ".*")) %>% 
                                              na.omit() %>% as.character() -> mi_ruta_al_gpr_en_la_iteracion
                                            
                                            append(new.FileName.path,str_replace(mi_ruta_al_gpr_en_la_iteracion,  "\\.gpr", "_Corrected.gpr")) -> new.FileName.path
                                             write_delim(DF_ok, path= new.FileName.path[i], delim= '\t', na = "NA", append = FALSE)
                                             
                                            append(GSM_corrected_files_in_order, new.FileName.path[i] %>% str_extract('GSM\\d+'))  -> GSM_corrected_files_in_order
                                           
}

list.files(path=new.FileName.path, recursive = F, full.names = T) %>% str_extract_all('.*_Corrected.gpr$') %>% unlist() -> FileName
FileName %>% str_extract('GSM\\d+') -> sample.names

data.frame(FileName)  %>% trqwe::set_rownames(sample.names)                    -> sample.names_files

for(i in 1:length(mis.targets)){
merge(mis.targets[i], sample.names_files, by=0) %>% column_to_rownames('Row.names') -> target.ok
}  
  RG          <- read.maimages(target.ok  ,columns=list(R="rMeanSignal",G="gMeanSignal",Rb="rBGMedianSignal",Gb="gBGMedianSignal"), annotation = "ProbeName")
RG.bc2      <-backgroundCorrect(RG,method="normexp")
RG.bc2.norm <- normalizeWithinArrays(RG.bc2, method="loess", weights = NULL)
modelMatrix(target.ok, ref = 'non_infected') -> design
  

```

```{r}
for(i in 1:length(names(my.tsv.DFs))){
  
                                            a.data.study          <- my.tsv.DFs[[i]]
                                            #
                                            my.cols.init.names    <- a.data.study %>% names() %>%
                                            str_extract_all("(^F[0-9]+.*Mean$)|(^B[0-9]+.*Mean$)|(Rgn.*R.*)|(r|g)MeanSignal$|(r|g)BGMedianSignal$") %>% unlist
                                            #
                                            my.cols.init.names %>% str_replace_all('[:whitespace:]|(Rgn.*R.*)', '')  -> my.cols.names.ok
                                            
                                            colnames(my.tsv.DFs[[i]][, my.cols.init.names]) <- my.cols.names.ok
                                            DF_ok <- my.tsv.DFs[[i]]
                                            
                                            names(my.tsv.DFs)[i] -> mi_gsm_en_la_iteracion
                                            
                                            str_extract(archivos_tsv, paste0(".*", mi_gsm_en_la_iteracion, ".*")) %>% 
                                              na.omit() %>% as.character() -> mi_ruta_al_txt_en_la_iteracion
                                            
                                            str_replace(mi_ruta_al_txt_en_la_iteracion,  "\\.txt", "_Corrected.txt") -> new.FileName.path
 
                                            write_delim(DF_ok, path= new.FileName.path, delim = "\t", na = "NA", append = FALSE)
                                            }
```

```{r}
for(i in 1:length(names(my.fpr.DFs))){
  
                                            a.data.study          <- my.fpr.DFs[[i]]
                                            #
                                            my.cols.init.names    <- a.data.study %>% names() %>%
                                            str_extract_all("(^F[0-9]+.*Mean$)|(^B[0-9]+.*Mean$)|(Rgn.*R.*)|(r|g)MeanSignal$|(r|g)BGMedianSignal$") %>% unlist
                                            #
                                            my.cols.init.names %>% str_replace_all('[:whitespace:]|(Rgn.*R.*)', '')  -> my.cols.names.ok
                                            
                                            colnames(my.fpr.DFs[[i]][, my.cols.init.names]) <- my.cols.names.ok
                                            DF_ok <- my.fpr.DFs[[i]]
                                            
                                            names(my.fpr.DFs)[i] -> mi_gsm_en_la_iteracion
                                            
                                            str_extract(archivos_fpr, paste0(".*", mi_gsm_en_la_iteracion, ".*")) %>% 
                                              na.omit() %>% as.character() -> mi_ruta_al_txt_en_la_iteracion
                                            
                                            str_replace(mi_ruta_al_txt_en_la_iteracion,  "\\.txt", "_Corrected.txt") -> new.FileName.path
 
                                            write_delim(DF_ok, path= new.FileName.path, delim = "\t", na = "NA", append = FALSE)
                                            }
```

```{r}
### Lo dejaré porsiacaso, pero no tiene sentido alguno
for(i in 1:length(names(my.tif.DFs))){
  
                                            a.data.study          <- my.tif.DFs[[i]]
                                            #
                                            my.cols.init.names    <- a.data.study %>% names() %>%
                                            str_extract_all("(^F[0-9]+.*Mean$)|(^B[0-9]+.*Mean$)|(Rgn.*R.*)|(r|g)MeanSignal$|(r|g)BGMedianSignal$") %>% unlist
                                            #
                                            my.cols.init.names %>% str_replace_all('[:whitespace:]|(Rgn.*R.*)', '')  -> my.cols.names.ok
                                            
                                            colnames(my.tif.DFs[[i]][, my.cols.init.names]) <- my.cols.names.ok
                                            DF_ok <- my.tif.DFs[[i]]
                                            
                                            names(my.tif.DFs)[i] -> mi_gsm_en_la_iteracion
                                            
                                            str_extract(archivos_tif, paste0(".*", mi_gsm_en_la_iteracion, ".*")) %>% 
                                              na.omit() %>% as.character() -> mi_ruta_al_txt_en_la_iteracion
                                            
                                            str_replace(mi_ruta_al_txt_en_la_iteracion,  "\\.txt", "_Corrected.txt") -> new.FileName.path
 
                                            write_delim(DF_ok, path= new.FileName.path, delim = "\t", na = "NA", append = FALSE)
                                            }
```

```{r}
for(i in 1:length(names(my.xml.DFs))){
  
                                            a.data.study          <- my.xml.DFs[[i]]
                                            #
                                            my.cols.init.names    <- a.data.study %>% names() %>%
                                            str_extract_all("(^F[0-9]+.*Mean$)|(^B[0-9]+.*Mean$)|(Rgn.*R.*)|(r|g)MeanSignal$|(r|g)BGMedianSignal$") %>% unlist
                                            #
                                            my.cols.init.names %>% str_replace_all('[:whitespace:]|(Rgn.*R.*)', '')  -> my.cols.names.ok
                                            
                                            colnames(my.xml.DFs[[i]][, my.cols.init.names]) <- my.cols.names.ok
                                            DF_ok <- my.xml.DFs[[i]]
                                            
                                            names(my.xml.DFs)[i] -> mi_gsm_en_la_iteracion
                                            
                                            str_extract(archivos_xml, paste0(".*", mi_gsm_en_la_iteracion, ".*")) %>% 
                                              na.omit() %>% as.character() -> mi_ruta_al_txt_en_la_iteracion
                                            
                                            str_replace(mi_ruta_al_txt_en_la_iteracion,  "\\.txt", "_Corrected.txt") -> new.FileName.path
 
                                            write_delim(DF_ok, path= new.FileName.path, delim = "\t", na = "NA", append = FALSE)
                                            }
```











