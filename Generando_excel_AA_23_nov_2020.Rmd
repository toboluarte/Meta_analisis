---
title: "Construyendo excel"
output: html_notebook
---

```{r}
library(easypackages)
librerias <- c("GEOquery","Biobase","BiocGenerics","magrittr","tidyr","dplyr","stringr","limma","EnhancedVolcano", "purrr","foreach","tidyverse", "xlsx")
libraries(librerias)
```

```{r}
#Armar mi ruta
pth <- file.path(getwd(),'mis_gse_data_1.rds')
```


```{r}
my_getGEO <- function (codigo_gse){
  try(getGEO(codigo_gse, GSEMatrix = TRUE, AnnotGPL = TRUE, getGPL = TRUE) -> my.gse.data)
  try(my.gse.data %<>% names %>% str_extract('GSE\\d+(-GPL\\d+)?') %>% set_names(my.gse.data,.))
  return(my.gse.data)}
mis.codigos.gse <- c('GSE1012','GSE1031','GSE6105','GSE6350','GSE6924','GSE9595','GSE10272','GSE6924','GSE13994','GSE15328','GSE19049','GSE19630','GSE20310','GSE18219','GSE19646','GSE26984','GSE28843','GSE30426','GSE30426','GSE28357','GSE34745','GSE35184','GSE35448','GSE35633','GSE35804','GSE36072','GSE36332','GSE38763','GSE40733','GSE26651','GSE39274','GSE42263','GSE42847','GSE44352','GSE47057','GSE51603','GSE51839','GSE56487','GSE43255','GSE45163','GSE58823','GSE87920','GSE101695','GSE140756')
mis_gse_data_1 <- map(mis.codigos.gse, my_getGEO) %>% unlist 


saveRDS(mis_gse_data_1, pth)
mis_gse_data_1 %>% names

```

```{r}
titulos                 <- data.frame()
list_con_eset_filtrados <- list()
RDS<- readRDS(pth)
b <- RDS %>% names
for(i in 1:length(b)) {
  if  (b[i]=="GSE6105"|b[i]=="GSE6350"|b[i]=="GSE19049"|b[i]=="GSE51603"){
       RDS[[i]]  -> mi.gse                                                                                             ####OK
       pData(mi.gse) %>% filter(str_detect(title,'control|infection')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
    
  }
    else if (b[i]== "GSE44352-GPL14875"|b[i] == "GSE44352-GPL15180'") {
       RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'zebrafish')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
    else if (b[i] == "GSE1012"| b[i]== "GSE1031"){ ### Hacer insensible a mayusculas
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>%filter(str_detect(source_name_ch1,'(?i)Non-infected|Piscirickettsia')& str_detect(source_name_ch2,'(?i)Non-infected|(?i)Piscirickettsia')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
    }
    else if (b[i] == "GSE6924-GPL2899"){
       RDS[[i]]  -> mi.gse; pData(mi.gse) %>%filter(str_detect(title,'day5|day9')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
    }
    else if (b[i] == "GSE6924-GPL3976"){
       RDS[[i]]  -> mi.gse; pData(mi.gse) %>%filter(str_detect(title,'controls') | str_detect(title, 'day1', negate= T)) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
        }
 
  else if (b[i] == "GSE9595"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'AGD'))  %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE10272"){ 
    RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'72h')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE13994"){
       RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'24hpi')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE15328"){
      RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'120hpi|6dpi|control|PBS')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE19630"){
       RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'16j|7j')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE20310"){
      RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'Infected|Not.infected')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE18219" | b[i] == "GSE19646"){
      RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(source_name_ch1,'(?i)control|infected') & str_detect(source_name_ch1,'(?i)exposed', negate = T)) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE26984"){
      RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(source_name_ch1,'infected')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE28843-GPL10679"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(title,'Heart.*4.wpi',negate = T) & str_detect(title, '4.wpi|10.wpi')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE28843-GPL10705"){
      RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(title,'8 wpi')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE30426"){
      RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(source_name_ch1,'3 p.i|not infected')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE28357"){
      RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(title,'0h|63d')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE34745"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(source_name_ch1,'Infected, Day 4|Control, Day 4')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE35184"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(source_name_ch1,'control|25')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE35448"){
    RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(title,'Susceptible')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE35804"){
      RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(title,'Naive')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE35633"){
      RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(source_name_ch1,'late infected|control')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE36332"){
    RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'Unvaccinated')) %>% filter(str_detect(title, '0h|72h')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE38763"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'No estrogen')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE40733"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'12h')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE26651"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'day2')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE39274"){
    RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'mutant', negate =T)) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE42263"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'non-infected') | str_detect(title, 'infected')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE42847-GPL14875"){
    RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(title,'Non-injected|5 DPI')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE42847-GPL15180"){
    RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(title,'126HPI|102HPI')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE47057"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'infected')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE51839"){
    RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(source_name_ch1,'21dpi')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
   else if (b[i] == "GSE56487"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(source_name_ch1,'-injected') & str_detect(source_name_ch1,'vaccine', negate = T)) %>% filter(str_detect(source_name_ch1, '72hpi')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
   }
   else if (b[i] == "GSE43255"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title, 'High')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
   }
   else if (b[i] == "GSE45163"){
    RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(title,'Control|12h after')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
   }
   else if (b[i] == "GSE58823"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'Control|VHSV')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
   }
   else if (b[i] == "GSE87920"){
    RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(source_name_ch1,'fed control')) %>% filter(str_detect(source_name_ch1,'20 days post challenge.')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
   }
  else if (b[i] == "GSE101695"){
    RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(characteristics_ch1.1,'control|infected')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE26981"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>%  filter(str_detect(title,'10|15')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado ####OK
  }
  else if (b[i] == "GSE42491"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(source_name_ch1,'24h|12h') & str_detect(source_name_ch2,'24h|12h')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado
  }
  else if (b[i] == "GSE3857"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(source_name_ch1,'control|exposed') & str_detect(source_name_ch2,'control|exposed')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado
  }
  else if (b[i] == "GSE36072"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'Placebo')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado
  }
  else if (b[i] == "GSE122142"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'Before') | str_detect(title,'36|43|57')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado
  }
  else if (b[i] == "GSE32119-GPL14575"| b[i]== "GSE32119-GPL6457"){
     RDS[[i]]  -> mi.gse; pData(mi.gse) %>% filter(str_detect(title,'(18|16)hpi')) %>% rownames %>% mi.gse[, .] -> un_eset_filtrado
  }
  
   titulos <- bind_rows(titulos,pData(un_eset_filtrado) )

   list_con_eset_filtrados[[b[i]]] <- un_eset_filtrado
}


list_con_eset_filtrados %>% map(pData) %>% enframe %>% unnest %>% 
                     dplyr::select(matches('^name$|title|geo|source|characteristics|organism')) -> GSMs_filtrados

GSMs_filtrados 
list_con_eset_filtrados

write.xlsx2(GSMs_filtrados, "~/Documents/Practica profesional/proyecto/try2.xlsx")
```

```{r}
### Target generations
list_con_eset_filtrados$`GSE6924-GPL3976` -> un_estudio


un_estudio     %>% pData %>% dplyr::select(matches('source.*ch') | matches('geo')| matches('label')) -> para_targets_0

para_targets_0 %>% mutate_at('source_name_ch1', ~str_replace(.,'.*control.*','control'))%>% 
                   mutate_at('source_name_ch1', ~str_replace(.,'.*challenged.*','infected'))%>% 
                   mutate_at('source_name_ch2', ~str_replace(.,'.*reference.*','control'))%>% 
                   unite("Alexa 555", source_name_ch1,label_ch1, sep ="-")%>% 
                   unite("Alexa 647", source_name_ch2,label_ch2, sep ="-")  %>%
                     mutate_at('Alexa 555', ~str_extract(.,".*(?=-Alexa)")) %>%
                     mutate_at('Alexa 647', ~str_extract(.,".*(?=-Alexa)")) %>% 
                     select(matches('alexa|geo')) -> `GSE6924-GPL3976`

list_con_eset_filtrados$GSE18219 -> un_estudio
un_estudio     %>% pData %>% dplyr::select(matches('source.*ch') | matches('geo')| matches('label')) %>% filter(str_detect(source_name_ch1,'exposed', negate = T)) %>%
                             mutate_at('source_name_ch1', ~str_replace(.,'.*control.*','control')) %>%
                             mutate_at('source_name_ch1', ~str_replace(.,'.*infected.*','infected'))%>%
                             mutate_at('source_name_ch2', ~str_replace(.,'.*reference.*','control')) %>% 
                                    unite("Channel 1", source_name_ch1,label_ch1, sep ="-") %>%
                                     unite("Channel 2", source_name_ch2,label_ch2, sep ="-") %>% 
                                     select(matches("channel|geo")) -> df

df %>% mutate(Cy5= ifelse( str_detect(`Channel 1`, "Cy5"), .[["Channel 1"]], .[["Channel 2"]]  ) ) %>% 
mutate(Cy3= ifelse( str_detect(`Channel 2`, "Cy3"), .[["Channel 2"]], .[["Channel 1"]]  ) ) %>%select(matches("cy|geo")) -> df_target


#Chequeo
chequear_GSMs <- function(df_target, df, fila){(df_target  %>% select(-geo_accession)  %>% as.matrix %>% .[fila,]) %in%
                                         (df         %>% select(-geo_accession)  %>% as.matrix  %>% .[fila,] ) %>% all -> OKs
 
                                           return(OKs)}


OKs <- as.logical()
for(i in 1:nrow(df_target)){
                         chequear_GSMs(df_target,df,fila=i) -> OKs[i]
                           }

OKs %>% all
df_target -> GSE18219

list_con_eset_filtrados$GSE6105 -> un_estudio
un_estudio     %>% pData %>% dplyr::select(matches('source.*ch') | matches('geo')| matches('label'))-> para_targets_0


para_targets_0 %>% mutate_at('source_name_ch1', ~str_replace(.,'.*control.*','control'))%>% 
                   mutate_at('source_name_ch1', ~str_replace(.,'.*infection.*','infected')) %>%
                   mutate(Biotin = source_name_ch1) %>% select(matches("geo|bio")) -> GSE6105
library(Hmisc)
llist(GSE6105,GSE18219,`GSE6924-GPL3976`) -> mis.targets
mis.targets
```

```{r}


```






